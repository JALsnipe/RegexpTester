var RetryHandler=function(){this.interval=1000;this.maxInterval=60*1000};RetryHandler.prototype.retry=function(a){setTimeout(a,this.interval);this.interval=this.nextInterval_()};RetryHandler.prototype.reset=function(){this.interval=1000};RetryHandler.prototype.nextInterval_=function(){var a=this.interval*2+this.getRandomInt_(0,1000);return Math.min(a,this.maxInterval)};RetryHandler.prototype.getRandomInt_=function(b,a){return Math.floor(Math.random()*(a-b+1)+b)};var MediaUploader=function(a){var b=function(){};this.file=a.file;this.contentType=a.contentType||this.file.type||"application/octet-stream";this.metadata=a.metadata||{title:this.file.name,mimeType:this.contentType};this.token=a.token;this.onComplete=a.onComplete||b;this.onError=a.onError||b;this.offset=a.offset||0;this.chunkSize=a.chunkSize||0;this.retryHandler=new RetryHandler();this.url=a.url;if(!this.url){var c=a.params||{};c.uploadType="resumable";this.url=this.buildUrl_(a.fileId,c)}this.httpMethod=this.fileId?"PUT":"POST"};MediaUploader.prototype.upload=function(){var a=this;var b=new XMLHttpRequest();b.open(this.httpMethod,this.url,true);b.setRequestHeader("Authorization","Bearer "+this.token);b.setRequestHeader("Content-Type","application/json");b.setRequestHeader("X-Upload-Content-Length",this.file.size);b.setRequestHeader("X-Upload-Content-Type",this.contentType);b.onload=function(d){var c=d.target.getResponseHeader("Location");this.url=c;this.sendFile_()}.bind(this);b.onerror=this.onUploadError_.bind(this);b.send(JSON.stringify(this.metadata))};MediaUploader.prototype.sendFile_=function(){var b=this.file;var a=this.file.size;if(this.offset||this.chunkSize){if(this.chunkSize){a=Math.min(this.offset+this.chunkSize,this.file.size)}b=b.slice(this.offset,a)}var c=new XMLHttpRequest();c.open("PUT",this.url,true);c.setRequestHeader("Content-Type",this.contentType);c.setRequestHeader("Content-Range","bytes "+this.offset+"-"+(a-1)+"/"+this.file.size);c.setRequestHeader("X-Upload-Content-Type",this.file.type);c.onload=this.onContentUploadSuccess_.bind(this);c.onerror=this.onContentUploadError_.bind(this);c.send(b)};MediaUploader.prototype.resume_=function(){var a=new XMLHttpRequest();a.open("PUT",this.url,true);a.setRequestHeader("Content-Range","bytes */"+this.file.size);a.setRequestHeader("X-Upload-Content-Type",this.file.type);a.onload=this.onContentUploadSuccess_.bind(this);a.onerror=this.onContentUploadError_.bind(this);a.send()};MediaUploader.prototype.extractRange_=function(b){var a=b.getResponseHeader("Range");if(a){this.offset=parseInt(a.match(/\d+/g).pop(),10)+1}};MediaUploader.prototype.onContentUploadSuccess_=function(a){if(a.target.status==200||a.target.status==201){this.onComplete(a.target.response)}else{if(a.target.status==308){this.extractRange_(a.target);this.retryHandler.reset();this.sendFile_()}}};MediaUploader.prototype.onContentUploadError_=function(a){if(a.target.status&&a.target.status<500){this.onError(a.target.response)}else{this.retryHandler.retry(this.resume_.bind(this))}};MediaUploader.prototype.onUploadError_=function(a){this.onError(a.target.response)};MediaUploader.prototype.buildQuery_=function(a){a=a||{};return Object.keys(a).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&")};MediaUploader.prototype.buildUrl_=function(d,c){var a="https://www.googleapis.com/upload/drive/v2/files/";if(d){a+=d}var b=this.buildQuery_(c);if(b){a+="?"+b}return a};